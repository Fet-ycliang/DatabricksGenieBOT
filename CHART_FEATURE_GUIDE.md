# ğŸ“Š åœ–è¡¨è¦–è¦ºåŒ–åŠŸèƒ½å®Œæ•´æŒ‡å—

## ç›®éŒ„

1. [å¿«é€Ÿé–‹å§‹](#å¿«é€Ÿé–‹å§‹)
2. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
3. [åœ–è¡¨é¡å‹](#åœ–è¡¨é¡å‹)
4. [ä½¿ç”¨èªªæ˜](#ä½¿ç”¨èªªæ˜)
5. [æŠ€è¡“å¯¦ç¾](#æŠ€è¡“å¯¦ç¾)
6. [æ¸¬è©¦èˆ‡é©—è­‰](#æ¸¬è©¦èˆ‡é©—è­‰)
7. [ç–‘é›£æ’è§£](#ç–‘é›£æ’è§£)

---

## å¿«é€Ÿé–‹å§‹

### 1ï¸âƒ£ å®‰è£ä¾è³´

```bash
# å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
cd D:/azure_code/DatabricksGenieBOT
./env/Scripts/activate

# å®‰è£å¥—ä»¶
pip install plotly>=5.0.0 kaleido>=0.2.1
```

æˆ–ä½¿ç”¨ requirements.txtï¼š
```bash
pip install -r requirements.txt
```

### 2ï¸âƒ£ é©—è­‰å®‰è£

```bash
python test_chart_generation.py
```

é æœŸè¼¸å‡ºï¼š
```
âœ… é•·æ¢åœ–ç”ŸæˆæˆåŠŸ
âœ… åœ“é¤…åœ–ç”ŸæˆæˆåŠŸ  
âœ… æŠ˜ç·šåœ–ç”ŸæˆæˆåŠŸ
```

### 3ï¸âƒ£ å•Ÿå‹•æ‡‰ç”¨

```bash
python -m aiohttp.web -P 5168 app:init_func
```

### 4ï¸âƒ£ æ¸¬è©¦ç¯„ä¾‹

åœ¨ Teams ä¸­æ¸¬è©¦ä»¥ä¸‹æŸ¥è©¢ï¼š

| æŸ¥è©¢ç¯„ä¾‹ | åœ–è¡¨é¡å‹ | èªªæ˜ |
|---------|---------|------|
| "å„ç”¢å“çš„éŠ·å”®é¡å‰5å" | ğŸ¥§ åœ“é¤…åœ– | 2-8ç­†æ•¸æ“šï¼Œç„¡è² å€¼ |
| "å„éƒ¨é–€äººæ•¸çµ±è¨ˆ" | ğŸ“Š é•·æ¢åœ– | æ¯”è¼ƒä¸åŒé¡åˆ¥ |
| "éå»6å€‹æœˆçš„ç‡Ÿæ”¶è¶¨å‹¢" | ğŸ“ˆ æŠ˜ç·šåœ– | æ™‚é–“åºåˆ—æ•¸æ“š |

---

## åŠŸèƒ½æ¦‚è¿°

### âœ¨ æ ¸å¿ƒç‰¹æ€§

- **è‡ªå‹•æ•¸æ“šåˆ†æ**: æ™ºèƒ½åˆ¤æ–·æ•¸æ“šæ˜¯å¦é©åˆè¦–è¦ºåŒ–
- **æ™ºèƒ½åœ–è¡¨é¸æ“‡**: æ ¹æ“šæ•¸æ“šç‰¹æ€§è‡ªå‹•é¸æ“‡æœ€é©åˆçš„åœ–è¡¨é¡å‹
- **é«˜å“è³ªåœ–ç‰‡**: ä½¿ç”¨ Plotly ç”Ÿæˆç¾ä»£åŒ–ã€ç¾è§€çš„åœ–è¡¨
- **Teams æ•´åˆ**: ç„¡ç¸«åµŒå…¥åˆ° Microsoft Teams Adaptive Card
- **ä¸­æ–‡æ”¯æŒ**: å®Œæ•´æ”¯æ´ä¸­æ–‡æ¨™ç±¤å’Œå­—é«”

### ğŸ¨ è¦–è¦ºæ•ˆæœ (Plotly)

#### ğŸ“Š é•·æ¢åœ– (Bar Chart)
- ç¾ä»£åŒ– Plotly é…è‰²æ–¹æ¡ˆ
- æ¸…æ™°çš„æ•¸å€¼æ¨™ç±¤é¡¯ç¤º
- åŠé€æ˜é‚Šæ¡†æ•ˆæœ
- æœ€ä½³çš„æŸ±ç‹€é–“è·

#### ğŸ¥§ åœ“é¤…åœ– (Pie Chart)
- ç’°å½¢åœ–è¨­è¨ˆ (hole=0.3)
- ç™½è‰²åˆ†éš”ç·š
- è‡ªå‹•ç™¾åˆ†æ¯”è¨ˆç®—
- å´é‚Šåœ–ä¾‹æ’åˆ—
- è±å¯Œçš„æ‡¸åœè³‡è¨Š

#### ğŸ“ˆ æŠ˜ç·šåœ– (Line Chart)
- é›™å±¤è¨­è¨ˆï¼šå¡«å……å€åŸŸ + ç·šæ¢
- åŠé€æ˜å€åŸŸå¡«å……
- ç™½è‰²é‚Šæ¡†æ¨™è¨˜é»
- çµ±ä¸€æ‡¸åœæ¨¡å¼
- è‡ªå‹•æ•¸å€¼æ¨™ç±¤å®šä½

---

## åœ–è¡¨é¡å‹

### 1. ğŸ“Š é•·æ¢åœ– (Bar Chart)

**é©ç”¨æƒ…æ³**:
- é è¨­åœ–è¡¨é¡å‹
- æ¯”è¼ƒä¸åŒé¡åˆ¥çš„æ•¸å€¼
- æ•¸æ“šç­†æ•¸ï¼š2-20 ç­†

**æ•¸æ“šè¦æ±‚**:
- è‡³å°‘ä¸€å€‹é¡åˆ¥æ¬„ä½ï¼ˆå­—ä¸²é¡å‹ï¼‰
- è‡³å°‘ä¸€å€‹æ•¸å€¼æ¬„ä½ï¼ˆæ•´æ•¸æˆ–æµ®é»æ•¸ï¼‰
- å¯åŒ…å«è² å€¼

**ç¯„ä¾‹æŸ¥è©¢**:
```
å„éƒ¨é–€çš„å“¡å·¥æ•¸é‡
å„ç”¢å“ç·šçš„éŠ·å”®é¡çµ±è¨ˆ
```

### 2. ğŸ¥§ åœ“é¤…åœ– (Pie Chart)

**é©ç”¨æƒ…æ³**:
- é¡¯ç¤ºéƒ¨åˆ†èˆ‡æ•´é«”çš„é—œä¿‚
- æ•¸æ“šç­†æ•¸ï¼š2-8 ç­†
- **ç„¡è² å€¼æ•¸æ“š**

**æ•¸æ“šè¦æ±‚**:
- é¡åˆ¥æ•¸é‡é©ä¸­ï¼ˆä¸è¶…é 8 å€‹ï¼‰
- æ‰€æœ‰æ•¸å€¼å¿…é ˆç‚ºæ­£æ•¸
- é©åˆå±•ç¤ºä½”æ¯”é—œä¿‚

**ç¯„ä¾‹æŸ¥è©¢**:
```
å„ç”¢å“çš„å¸‚å ´ä½”æœ‰ç‡
å„åœ°å€çš„éŠ·å”®åˆ†å¸ƒ
```

### 3. ğŸ“ˆ æŠ˜ç·šåœ– (Line Chart)

**é©ç”¨æƒ…æ³**:
- é¡¯ç¤ºæ™‚é–“åºåˆ—æˆ–è¶¨å‹¢è®ŠåŒ–
- é¡åˆ¥æ¬„åŒ…å«æ™‚é–“ç›¸é—œé—œéµå­—
- æ•¸æ“šç­†æ•¸ï¼š2-20 ç­†

**è§¸ç™¼æ¢ä»¶**:
é¡åˆ¥æ¬„åç¨±åŒ…å«ï¼š`date`, `time`, `month`, `year`, `day`, `æ—¥æœŸ`, `æ™‚é–“`, `æœˆä»½`, `å¹´`

**ç¯„ä¾‹æŸ¥è©¢**:
```
éå»12å€‹æœˆçš„ç‡Ÿæ”¶è¶¨å‹¢
æ¯æ—¥æ´»èºç”¨æˆ¶æ•¸è®ŠåŒ–
```

---

## ä½¿ç”¨èªªæ˜

### è‡ªå‹•åœ–è¡¨ç”Ÿæˆæµç¨‹

```
ç”¨æˆ¶æŸ¥è©¢
    â†“
Databricks Genie API è¿”å›æ•¸æ“š
    â†“
_analyze_chart_suitability() åˆ†æ
    â”œâ”€ æª¢æŸ¥æ•¸æ“šç­†æ•¸ï¼ˆ2-20ï¼‰
    â”œâ”€ è­˜åˆ¥é¡åˆ¥æ¬„å’Œæ•¸å€¼æ¬„
    â”œâ”€ æª¢æŸ¥æ˜¯å¦æœ‰è² å€¼
    â””â”€ æ ¹æ“šæ¢ä»¶æ±ºå®šåœ–è¡¨é¡å‹
    â†“
å¦‚æœé©åˆç¹ªåœ–ï¼š
    â”œâ”€ generate_chart_image() ç”Ÿæˆ
    â”‚   â”œâ”€ ä½¿ç”¨ Plotly ç¹ªè£½
    â”‚   â”œâ”€ è½‰æ›ç‚º PNG (900x500, scale=2)
    â”‚   â””â”€ Base64 ç·¨ç¢¼
    â””â”€ create_chart_card_with_image()
        â””â”€ åµŒå…¥ Adaptive Card ä¸¦ç™¼é€
```

### åœ–è¡¨é¸æ“‡é‚è¼¯

```python
if æ•¸æ“šç­†æ•¸ < 2 or > 20:
    ä¸ç”Ÿæˆåœ–è¡¨
elif æ•¸æ“šç­†æ•¸åœ¨ 2-8 ä¹‹é–“ ä¸” ç„¡è² å€¼:
    ä½¿ç”¨åœ“é¤…åœ–
elif é¡åˆ¥æ¬„åŒ…å«æ™‚é–“é—œéµå­—:
    ä½¿ç”¨æŠ˜ç·šåœ–
else:
    ä½¿ç”¨é•·æ¢åœ–ï¼ˆé è¨­ï¼‰
```

### ç™¼é€é †åº

ç•¶æŸ¥è©¢è¿”å›é©åˆè¦–è¦ºåŒ–çš„æ•¸æ“šæ™‚ï¼š

1. **ä¸»è¦å›æ‡‰**: Markdown æ ¼å¼çš„æ•¸æ“šè¡¨æ ¼
2. **åœ–è¡¨å¡ç‰‡**: Plotly ç”Ÿæˆçš„åœ–è¡¨åœ–ç‰‡
3. **å»ºè­°å•é¡Œ**: ç›¸é—œçš„å¾ŒçºŒæŸ¥è©¢å»ºè­°
4. **å›é¥‹æŒ‰éˆ•**: æ­£é¢/è² é¢åé¥‹

---

## æŠ€è¡“å¯¦ç¾

### æª”æ¡ˆçµæ§‹

| æª”æ¡ˆ | åŠŸèƒ½ |
|------|------|
| `chart_generator.py` | åœ–è¡¨ç”Ÿæˆæ ¸å¿ƒæ¨¡çµ„ |
| `genie_service.py` | åŒ…å« `_analyze_chart_suitability()` |
| `app.py` | åœ–è¡¨å¡ç‰‡ç™¼é€é‚è¼¯ |
| `test_chart_generation.py` | åŠŸèƒ½æ¸¬è©¦è…³æœ¬ |

### æ ¸å¿ƒå‡½å¼

#### 1. `_analyze_chart_suitability(columns, data)`

**ä½ç½®**: `genie_service.py`  
**åŠŸèƒ½**: åˆ†ææ•¸æ“šä¸¦æ±ºå®šåœ–è¡¨é¡å‹

**å›å‚³**:
```python
{
    'suitable': True/False,
    'chart_type': 'bar'/'pie'/'line',
    'category_column': 'æ¬„ä½åç¨±',
    'value_column': 'æ¬„ä½åç¨±',
    'data_for_chart': [
        {'category': 'é¡åˆ¥1', 'value': 100},
        {'category': 'é¡åˆ¥2', 'value': 200}
    ]
}
```

#### 2. `generate_chart_image(chart_info)`

**ä½ç½®**: `chart_generator.py`  
**åŠŸèƒ½**: ä½¿ç”¨ Plotly ç”Ÿæˆåœ–è¡¨ä¸¦è½‰æ›ç‚º base64

**æŠ€è¡“ç´°ç¯€**:
- ä½¿ç”¨ `plotly.graph_objects` API
- æ”¯æ´ä¸­æ–‡å­—é«”ï¼šMicrosoft JhengHei, Arial
- åœ–ç‰‡å°ºå¯¸ï¼š900x500 pixels, scale=2
- è¼¸å‡ºæ ¼å¼ï¼šPNG (base64 ç·¨ç¢¼)

**ç¯„ä¾‹**:
```python
import plotly.graph_objects as go
import plotly.io as pio

# å‰µå»ºåœ–è¡¨
fig = go.Figure(data=[go.Bar(...)])
fig.update_layout(...)

# è½‰æ›ç‚º PNG
image_bytes = pio.to_image(fig, format='png', width=900, height=500, scale=2)
image_base64 = base64.b64encode(image_bytes).decode('utf-8')
```

#### 3. `create_chart_card_with_image(chart_info)`

**ä½ç½®**: `chart_generator.py`  
**åŠŸèƒ½**: å‰µå»ºåŒ…å«åœ–è¡¨çš„ Adaptive Card

**Adaptive Card çµæ§‹**:
```json
{
  "type": "AdaptiveCard",
  "version": "1.5",
  "body": [
    {
      "type": "Container",
      "style": "emphasis",
      "items": [
        // åœ–ç¤º + æ¨™é¡Œ
      ]
    },
    {
      "type": "Image",
      "url": "data:image/png;base64,iVBOR...",
      "size": "Stretch"
    },
    {
      "type": "TextBlock",
      "text": "ğŸ“Š å…± X ç­†æ•¸æ“š | åœ–è¡¨é¡å‹"
    }
  ]
}
```

### ä¾è³´å¥—ä»¶

| å¥—ä»¶ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| plotly | >=5.0.0 | åœ–è¡¨ç”Ÿæˆ |
| kaleido | >=0.2.1 | éœæ…‹åœ–ç‰‡å°å‡º |

### Plotly å„ªå‹¢

âœ… **æ›´ç¾è§€**: ç¾ä»£åŒ–è¦–è¦ºè¨­è¨ˆ  
âœ… **æ›´ç°¡æ½”**: API æ›´ç›´è§€æ˜“ç”¨  
âœ… **æ›´å¥½çš„ä¸­æ–‡æ”¯æ´**: å…§å»ºå¤šç¨®å­—é«”  
âœ… **æ›´ç²¾ç¢º**: æ¨£å¼æ§åˆ¶æ›´ç´°ç·»  
âœ… **å…ç¶­è­·**: ä¸éœ€è¦æ‰‹å‹•ç®¡ç†å¾Œç«¯

---

## æ¸¬è©¦èˆ‡é©—è­‰

### æœ¬åœ°æ¸¬è©¦

#### 1. åŸ·è¡Œæ¸¬è©¦è…³æœ¬

```bash
python test_chart_generation.py
```

**é æœŸè¼¸å‡º**:
```
ğŸ§ª æ¸¬è©¦åœ–è¡¨ç”ŸæˆåŠŸèƒ½

1ï¸âƒ£ æ¸¬è©¦é•·æ¢åœ–...
âœ… é•·æ¢åœ–ç”ŸæˆæˆåŠŸ
   å¡ç‰‡åŒ…å« 3 å€‹å…ƒç´ 

2ï¸âƒ£ æ¸¬è©¦åœ“é¤…åœ–...
âœ… åœ“é¤…åœ–ç”ŸæˆæˆåŠŸ
   å¡ç‰‡åŒ…å« 3 å€‹å…ƒç´ 

3ï¸âƒ£ æ¸¬è©¦æŠ˜ç·šåœ–...
âœ… æŠ˜ç·šåœ–ç”ŸæˆæˆåŠŸ
   å¡ç‰‡åŒ…å« 3 å€‹å…ƒç´ 
âœ… å¡ç‰‡åŒ…å«åœ–ç‰‡å…ƒç´ 

==================================================
âœ… æ¸¬è©¦å®Œæˆï¼
==================================================
```

#### 2. æ‰‹å‹•æ¸¬è©¦

```python
from chart_generator import generate_chart_image, create_chart_card_with_image

# æº–å‚™æ¸¬è©¦æ•¸æ“š
chart_info = {
    'suitable': True,
    'chart_type': 'bar',
    'category_column': 'ç”¢å“',
    'value_column': 'éŠ·å”®é¡',
    'data_for_chart': [
        {'category': 'ç”¢å“A', 'value': 1000},
        {'category': 'ç”¢å“B', 'value': 1500},
        {'category': 'ç”¢å“C', 'value': 800}
    ]
}

# ç”Ÿæˆåœ–è¡¨
image_base64 = generate_chart_image(chart_info)
print(f"åœ–ç‰‡é•·åº¦: {len(image_base64)} å­—å…ƒ")

# å‰µå»ºå¡ç‰‡
card = create_chart_card_with_image(chart_info)
print(f"å¡ç‰‡åŒ…å« {len(card['body'])} å€‹å…ƒç´ ")
```

### Teams æ¸¬è©¦

1. å•Ÿå‹• Bot æ‡‰ç”¨
2. åœ¨ Teams ä¸­ç™¼é€æ¸¬è©¦æŸ¥è©¢
3. é©—è­‰ä»¥ä¸‹é …ç›®ï¼š

**é©—è­‰æ¸…å–®**:
- [ ] æ•¸æ“šè¡¨æ ¼æ­£ç¢ºé¡¯ç¤º
- [ ] åœ–è¡¨å¡ç‰‡å‡ºç¾
- [ ] åœ–è¡¨åœ–ç‰‡æ­£å¸¸é¡¯ç¤º
- [ ] ä¸­æ–‡æ¨™ç±¤ç„¡äº‚ç¢¼
- [ ] åœ–è¡¨é¡å‹ç¬¦åˆé æœŸ
- [ ] å»ºè­°å•é¡Œåˆ—è¡¨å‡ºç¾

---

## ç–‘é›£æ’è§£

### å¸¸è¦‹å•é¡Œ

#### 1. åœ–è¡¨æ²’æœ‰å‡ºç¾

**å¯èƒ½åŸå› **:
- æ•¸æ“šç­†æ•¸ä¸åœ¨ 2-20 ç¯„åœå…§
- ç¼ºå°‘é¡åˆ¥æ¬„æˆ–æ•¸å€¼æ¬„
- åœ“é¤…åœ–åŒ…å«è² å€¼

**æª¢æŸ¥æ–¹æ³•**:
```bash
# æŸ¥çœ‹æ‡‰ç”¨æ—¥èªŒ
python -m aiohttp.web -P 5168 app:init_func

# è§€å¯Ÿ [request_id] æ—¥èªŒä¸­çš„ "åˆ†æåœ–è¡¨é©ç”¨æ€§" è¨Šæ¯
```

#### 2. ImportError: cannot import Plotly

**è§£æ±ºæ–¹æ¡ˆ**:
```bash
pip install --upgrade plotly kaleido
```

#### 3. ä¸­æ–‡é¡¯ç¤ºäº‚ç¢¼

**è§£æ±ºæ–¹æ¡ˆ**:
- Windows: ç³»çµ±é è¨­å·²å®‰è£ Microsoft JhengHei
- Linux: å®‰è£ä¸­æ–‡å­—é«”
  ```bash
  sudo apt-get install fonts-wqy-microhei
  ```

#### 4. åœ–ç‰‡ç”Ÿæˆè¶…æ™‚

**å¯èƒ½åŸå› **: kaleido æœªæ­£ç¢ºå®‰è£

**è§£æ±ºæ–¹æ¡ˆ**:
```bash
pip uninstall kaleido
pip install kaleido>=0.2.1
```

#### 5. Adaptive Card é¡¯ç¤ºç•°å¸¸

**æª¢æŸ¥é …ç›®**:
- Base64 ç·¨ç¢¼æ˜¯å¦æ­£ç¢º
- åœ–ç‰‡ URL æ ¼å¼ï¼š`data:image/png;base64,...`
- Teams æ˜¯å¦æ”¯æ´è©²ç‰ˆæœ¬çš„ Adaptive Card (1.5)

### èª¿è©¦æ¨¡å¼

åœ¨ `chart_generator.py` ä¸­å•Ÿç”¨è©³ç´°æ—¥èªŒï¼š

```python
import logging

logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

def generate_chart_image(chart_info):
    logger.debug(f"ç”Ÿæˆåœ–è¡¨: {chart_info['chart_type']}")
    logger.debug(f"æ•¸æ“šç­†æ•¸: {len(chart_info['data_for_chart'])}")
    # ...
```

### æ€§èƒ½å„ªåŒ–

#### åœ–ç‰‡å¤§å°å„ªåŒ–

å¦‚æœåœ–ç‰‡éå¤§ï¼Œå¯èª¿æ•´åƒæ•¸ï¼š

```python
# åœ¨ chart_generator.py ä¸­
image_bytes = pio.to_image(
    fig, 
    format='png', 
    width=800,      # é™ä½å¯¬åº¦
    height=450,     # é™ä½é«˜åº¦
    scale=1.5       # é™ä½ç¸®æ”¾æ¯”ä¾‹
)
```

#### å¿«å–æ©Ÿåˆ¶ (å¯é¸)

å°æ–¼é‡è¤‡æŸ¥è©¢ï¼Œå¯è€ƒæ…®å¯¦ç¾å¿«å–ï¼š

```python
from functools import lru_cache
import hashlib

def get_data_hash(chart_info):
    data_str = str(chart_info['data_for_chart'])
    return hashlib.md5(data_str.encode()).hexdigest()

@lru_cache(maxsize=100)
def generate_chart_image_cached(data_hash, chart_info_str):
    chart_info = eval(chart_info_str)
    return generate_chart_image(chart_info)
```

---

## é™„éŒ„

### æ•¸æ“šç¯„ä¾‹

#### é©åˆåœ“é¤…åœ–çš„æ•¸æ“š

| ç”¢å“ | éŠ·å”®é¡ |
|------|--------|
| ç”¢å“A | 1000 |
| ç”¢å“B | 1500 |
| ç”¢å“C | 800 |

âœ… 3ç­†æ•¸æ“šï¼Œç„¡è² å€¼ â†’ åœ“é¤…åœ–

#### é©åˆæŠ˜ç·šåœ–çš„æ•¸æ“š

| æœˆä»½ | ç‡Ÿæ”¶ |
|------|------|
| 2024-01 | 50000 |
| 2024-02 | 55000 |
| 2024-03 | 52000 |

âœ… é¡åˆ¥æ¬„åŒ…å« "æœˆä»½" â†’ æŠ˜ç·šåœ–

#### ä¸é©åˆç¹ªåœ–çš„æ•¸æ“š

| ç”¢å“ | æè¿° |
|------|------|
| A | é›»å­ç”¢å“ |
| B | å®¶å…· |

âŒ ç¼ºå°‘æ•¸å€¼æ¬„ â†’ ä¸ç”Ÿæˆåœ–è¡¨

### ç›¸é—œè³‡æº

- [Plotly Python æ–‡æª”](https://plotly.com/python/)
- [Adaptive Cards è¨­è¨ˆå™¨](https://adaptivecards.io/designer/)
- [Microsoft Teams Bot é–‹ç™¼](https://learn.microsoft.com/azure/bot-service/)

### æ›´æ–°æ­·å²

| æ—¥æœŸ | ç‰ˆæœ¬ | è®Šæ›´å…§å®¹ |
|------|------|---------|
| 2026-01-05 | 2.0 | é·ç§»åˆ° Plotlyï¼Œæ”¹é€²è¦–è¦ºæ•ˆæœ |
| 2026-01-03 | 1.0 | åˆå§‹å¯¦ç¾ï¼Œä½¿ç”¨ matplotlib |

---

**æ–‡æª”ç‰ˆæœ¬**: 2.0  
**æœ€å¾Œæ›´æ–°**: 2026-01-05  
**ç¶­è­·è€…**: DatabricksGenieBOT Team
